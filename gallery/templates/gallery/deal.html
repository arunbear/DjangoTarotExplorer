{% extends "gallery/main.html" %}
{% load static %}

{% block local_scripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="{% static 'js/tarot-deck.js' %}"></script>

    <script>
        let deck;

        function updateButtonStates(states) {
            $('#btn-deal').prop('disabled', !states.dealEnabled);
            $('#btn-back').prop('disabled', !states.backEnabled);
            $('#btn-shuffle').prop('disabled', !states.shuffleEnabled);
        }

        function refreshCards() {
            const cards = deck.getCurrentCards();
            
            $('#image-1').prop('src', deck.getCardDisplaySrc(cards[0]));
            $('#caption-1 .card-number').text(deck.getCardDisplayCaption(cards[0]));
            
            $('#image-2').prop('src', deck.getCardDisplaySrc(cards[1]));
            $('#caption-2 .card-number').text(deck.getCardDisplayCaption(cards[1]));
            
            if (deck.numOfCardsToDeal === 3) {
                $('#figure-3').css('display', 'block');
                $('#image-3').prop('src', deck.getCardDisplaySrc(cards[2]));
                $('#caption-3 .card-number').text(deck.getCardDisplayCaption(cards[2]));
            } else {
                $('#figure-3').css('display', 'none');
            }
            
            // Apply reversal states based on actual card numbers (caption)
            cards.forEach((card, index) => {
                if (card && card.caption) {
                    const imageId = `#image-${index + 1}`;
                    const shouldReverse = deck.cardIsReversedAtPos[card.caption];
                    console.log(`Card ${card.caption} should reverse: ${shouldReverse}`); // Debug log
                    if (shouldReverse) {
                        $(imageId).addClass('rotated');
                    } else {
                        $(imageId).removeClass('rotated');
                    }
                }
            });
        }

        $(document).ready(function() {
            // Initialize deck with data from Django template
            deck = new TarotDeck({{ images_json|safe }}, '{{ back_of_card_img }}');

            $('#btn-deal').on('click', function () {
                const states = deck.deal();
                updateButtonStates(states);
                refreshCards();
            });
            
            $('#btn-back').on('click', function () {
                const states = deck.back();
                updateButtonStates(states);
                refreshCards();
            });
            
            $('#btn-shuffle').on('click', function () {
                const states = deck.reset();
                updateButtonStates(states);
                refreshCards();
            });
            
            $('#chk-include-trumps').change(function () {
                deck.setIncludeTrumps(this.checked);
                const states = deck.getButtonStates();
                updateButtonStates(states);
                refreshCards();
            });

            $("input:radio").click(function () {
                const value = $(this).val();
                if (value === '2') {
                    deck.setNumOfCards(2);
                    $('#card-holder').css('grid-template-columns', '1fr 1fr');
                } else if (value === '3') {
                    deck.setNumOfCards(3);
                    $('#card-holder').css('grid-template-columns', '1fr 1fr 1fr');
                }
                const states = deck.getButtonStates();
                updateButtonStates(states);
                refreshCards();
            });
            
            // Card click handlers
            $('.card').on('click', function(e) {
                e.stopPropagation();
                
                const cardId = $(this).attr('id');
                const position = parseInt(cardId.split('-')[1]) - 1;
                const cards = deck.getCurrentCards();
                const card = cards[position];
                
                // If face-down is enabled and card exists, reveal it
                if (deck.faceDownEnabled && card && card.caption) {
                    if (!deck.cardIsFaceDownAtPos[card.caption]) {
                        deck.revealCard(card.caption);
                        refreshCards();
                        return; // Don't process selection when revealing
                    }
                }
                
                // If clicking the already selected card, deselect it
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                } else {
                    // Remove selection from all cards, then select this one
                    $('.card').removeClass('selected');
                    $(this).addClass('selected');
                }
            });
            
            // Rotation link handlers - use event delegation and prevent bubbling
            $(document).on('click', '.rotate-link', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Rotation link clicked'); // Debug log
                const cardNumber = $(this).data('card');
                const imageId = `#image-${cardNumber}`;
                console.log('Toggling rotation on', imageId); // Debug log
                $(imageId).toggleClass('rotated');
            });
            
            // Reversed cards checkbox handler
            $('#chk-reversed-cards').change(function() {
                const isReversed = $(this).is(':checked');
                deck.setReversedCardsEnabled(isReversed);
                
                if (!isReversed) {
                    $('.card').removeClass('rotated');
                }
                
                refreshCards(); // Apply the new reversal states
            });
            
            // Face down cards checkbox handler
            $('#chk-face-down').change(function() {
                const isFaceDown = $(this).is(':checked');
                deck.setFaceDownEnabled(isFaceDown);
                refreshCards(); // Apply the new face-down states
            });
            
            // Initial render
            const states = deck.getButtonStates();
            updateButtonStates(states);
            refreshCards();
        });
    </script>
{% endblock %}

{% block local_style %}
    body {
        font-family: Arial, sans-serif;
    }

    .card-holder {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 1px;
        align-items: stretch;
        justify-items: center;
    }

    .card-holder figure img {
        max-width: 100%;
        object-fit: contain;
        transition: transform 0.2s ease, border 0.2s ease, box-shadow 0.2s ease;
    }

    @media only screen and (min-width: 920px) {
        .card-holder figure img {
            max-width: 100%;
            width: auto;
            height: 70vh;
        }
    }

    .button-holder {
        text-align: center;
    }
    .button {
        margin: 1%;
    }
    .rotate-btn {
        background: none;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 8px;
        margin-top: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: transform 0.3s ease;
    }
    .rotate-btn:hover {
        background-color: #f0f0f0;
        border-color: #999;
    }
    .rotate-link {
        display: block;
    }
    .card.rotated {
        transform: rotate(180deg);
    }
    .card.selected {
        transform: scale(1.15);
        transition: transform 0.2s ease;
    }
    .card.selected.rotated {
        transform: rotate(180deg) scale(1.15);
    }
    .card.selected:not(.rotated) {
        transform: scale(1.15);
    }

{% endblock %}

{% block content %}
    <div class="card-holder" id="card-holder">
        <figure>
            <img id="image-1" class="card" src="{{ back_of_card_img }}">
            <figcaption id="caption-1" style="text-align: center">
                <a href="#" class="rotate-link" data-card="1" title="Reverse">
                    <span class="card-number"></span>
                </a>
            </figcaption>
        </figure>
        <figure>
            <img id="image-2" class="card" src="{{ back_of_card_img }}" alt="tarot-card">
            <figcaption id="caption-2" style="text-align: center">
                <a href="#" class="rotate-link" data-card="2" title="Reverse">
                    <span class="card-number"></span>
                </a>
            </figcaption>
        </figure>
        <figure id="figure-3" style="display: none">
            <img id="image-3" class="card" src="{{ back_of_card_img }}" alt="tarot-card">
            <figcaption id="caption-3" style="text-align: center">
                <a href="#" class="rotate-link" data-card="3" title="Reverse">
                    <span class="card-number"></span>
                </a>
            </figcaption>
        </figure>
    </div>
    <div class="button-holder">
        <button id="btn-shuffle" class="button" title="Reshuffle the whole deck" disabled="disabled">Shuffle</button>
        <button id="btn-deal" class="button" title="Deal cards from the deck">Deal</button>
        <button id="btn-back" class="button" title="View previous cards" disabled="disabled">Back</button>
        <hr/>

        <label>
            Include trumps
            <input type="checkbox" id="chk-include-trumps"/>
        </label>

        <label>
            &nbsp; Reversed cards
            <input type="checkbox" id="chk-reversed-cards"/>
        </label>

        <label>
            &nbsp; Face down
            <input type="checkbox" id="chk-face-down"/>
        </label>

        &nbsp; Number of cards:
        <input type="radio" id="num_cards_2" name="num_cards" value="2" checked="checked">
        <label for="num_cards_2">2</label>
        <input type="radio" id="num_cards_3" name="num_cards" value="3">
        <label for="num_cards_3">3</label>
    </div>
{% endblock %}
